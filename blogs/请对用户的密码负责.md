在之前的分享中，大家能看到 `jump-jump` 已经可以使用了，但我们希望只能是有账号的用户才可以去创建、修改短链接或是查看数据报表，所以我们得写一个用户模块，可以创建用户账号，可以登陆到系统。而这次分享，会主要说说用户模块最重要的一部分——怎样安全的存储用户密码。

## 怎样安全的存储用户密码
用户模块或是用户系统，无处不在，或许有的人会因此觉得存储用户密码是一件特别简单的事情，但如果实际去做的话，或许会有你没考虑过的问题。

试想一下，如果我们把用户的密码明文写到数据库中会有什么问题？
> 2011年12月，CSDN、多玩、世纪佳缘、走秀等多家网站的用户数据库被曝光在网络上，由于部分密码以明文方式显示，导致大量网民受到隐私泄露的威胁。最早牵涉这一事件的CSDN已经报案，但围绕“谁是窃取曝光这些数据库”这一问题，网络上有诸多传言。——百度百科（密码外泄门）

正因为用户的密码是明文保存在数据库，所以一旦数据库被黑了，所有用户的密码也就曝光了，用户的隐私、财产等都会受到威胁，所以在存储用户密码这件事上，我们必须要慎重。虽然事实上不存在绝对的安全，但我们仍要尽可能保证用户的密码是相对安全的。

### 存储加密后的密码
我们已经知道不能存储明文的密码，那么我们应该存些什么呢？

事实证明，我们应该把经过加密的密码存储到数据库，而加密，就是通过**哈希算法**计算这个密码的哈希值，最后写入数据库的是这个哈希值而不是明文的密码。

**哈希算法**，是一种从任何一种数据中创建小的数字“指纹”的方法。
```
hash("mypasswd") = 0316001ef027cb1e25658d9faa50cb4c685223867f8a4d42b7994d817f0d2424
hash("mjstudio") = 709b660bc3a4b6700d9baea279d46299b2f4eafc4e6a6d6e0315c4b50531021c
```

这时候再试想一下，如果数据库被黑，但是密码都是加密后的密码，黑客也无法马上知道所有用户的密码，从而减少、减缓用户的损失。

我们可以列一下这时候正常用户在创建账号和登陆账号的流程：
1. 用户创建自己的账号；
2. 用户的密码经过**哈希算法**加密后被写入到数据库；
3. 用户登陆时，输入用户名和密码，用户模块根据用户名查找是否存在该用户名的数据，如果存在则可以得到加密后的密码，此时使用同样的**哈希算法**加密用户输入的密码后和数据库中加密后的密码做比对；
4. 如果密码相同，则登陆成功，否则会告诉登陆用户“用户名或密码错误”。

在上述流程中，流程4是特别需要注意的，**永远不要告诉尝试登陆的用户到底是用户名错误还是密码错误**，这样能防止攻击者在不知道密码的情况下枚举出所有有效用户名。

或许有人认为做到这里就够了，虽然的确是比明文存储安全了一些，但要破解单纯使用**哈希算法**加密过的密码还是有方法和手段的：
- 网络上有破解哈希值的网站，输入哈希值，就能得到明文结果；
- 字典攻击；
- 暴力攻击。

这里不会展开讲这些方法和手段，但主要的原理就是**穷举**。如果你手上有一张用户数据表，里面的密码是加密后的字符串，此时如果你想知道每个用户的密码具体是什么，那么你能做的只能是不断的尝试生成加密的密码然后跟数据库中的密码做比对，至于不同的方法，只是让你在时间或者空间上得到一个优化。

### 加盐
如果我们在使用**哈希算法**为密码加密时加点料呢？是的，这里会在加密时为**加盐**，如：
```
hash("mypasswd") = 0316001ef027cb1e25658d9faa50cb4c685223867f8a4d42b7994d817f0d2424
hash("mypasswd" + "MJWF1bgIAdeQX") = 7bd0ee67eb832fdc12e105bb9087bfde1b400178a80145c9634d75ef43aebe94
hash("mypasswd" + "BALA1bgIAdeQX") = 803f55a88cf6626bc2c6bcb273881057f3de8dadf72b4634f6c758ec36c2aea3
```

我们在为密码加密时，加入一个随机的字符串，一般被称为**盐值**，这样我们加密出来的结果又发生了变化了。

如果你现在手上有一张用户数据表，里面的密码是**加盐密码哈希**，而你现在想破解其中一个用户的密码，你所需要花费的时间和空间甚至会比你破解之前的整个库的密码还要多，当然可能有些夸张，具体还是要看数据量和**盐值**长度等因素。

总而言之，经过**加盐**，需要破解得出明文密码已经很困难了，而**加盐密码哈希**正是 `jump-jump` 在存储用户密码时所使用的方案。

如果想看深入一点的内容，可以看这篇有 Defuse 写的 `Salted Password Hashing - Doing it Right`：
https://crackstation.net/hashing-security.htm

## Go 中生成 加盐密码哈希
使用 `Go` 语言加密相关的扩充库 `crypto/scrypt`，使用起来很简单，`scrypt` 也是**莱特币**的挖矿算法。
```go
package main

import (
  "crypto/rand"
  "golang.org/x/crypto/scrypt"
  "fmt"
)

func main() {
  // 生成随机盐值
  salt := make([]byte, 32)
  _, err := rand.Read(salt)
  if err != nil {
    // 处理 err
  }
  fmt.Printf("随机盐值：%x\n", salt)

  // 加盐密码哈希
  dk, _ := scrypt.Key([]byte("mj-studio"), salt, 1<<15, 8, 1, 32)
  fmt.Printf("加盐密码哈希：%x\n", dk)
}
```

对密码的安全加密和实现有了了解后，就可以应用到 `jump-jump` 里了，最新的代码库已包含创建用户、用户登陆功能（https://github.com/jwma/jump-jump）。

## 写在最后
`jump-jump` 中使用的方案并不是最安全的方案，而是最合适的，如果抛开实际而单纯从学术的角度去看安全问题，我觉得我也无能为力去实现各种各样的方案。

安全，是一个没有终点的话题，这更像是攻防战，有人攻击自然就有人会想着怎么防守。
